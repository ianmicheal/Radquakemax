
/************************************************\
 * speud (27-06-2004)                           *
 *                                              *
 * 	- Replaced fprintf                      *
 * 	- Implemented VMU support               *
 *      - Added Host_ReadConfiguration()        *
 *                                              *
\************************************************/


#include <kos.h>
#include <zlib/zlib.h>

#include "vmu_misc.h"
#include "vmu_config.h"

#include "quakedef.h"


cvar_t	vmu_port;
cvar_t	vmu_unit;
cvar_t	vmu_autosave;
cvar_t	vmu_disp;

uint8 anim_palette[32] = {
	0x00, 0xF1, 0x10, 0xF2, 0x21, 0xF2, 0x22, 0xF3, 0x32, 0xF4, 0x43, 0xF6, 0x54, 0xF6, 0x53, 0xF9,
	0x64, 0xF8, 0x62, 0xFB, 0x72, 0xFB, 0x86, 0xFA, 0x72, 0xFC, 0x86, 0xFB, 0x97, 0xFC, 0xFF, 0xFF
};

uint8 anim_bitmap[3*512] = {
	0x00, 0x12, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x21, 0x00, 0x00,
	0x11, 0x11, 0x22, 0x33, 0x33, 0x45, 0x56, 0x66, 0x55, 0x55, 0x44, 0x33, 0x33, 0x31, 0x01, 0x11,
	0x12, 0x11, 0x33, 0x33, 0x44, 0x66, 0x68, 0xB8, 0x66, 0x66, 0x65, 0x44, 0x33, 0x33, 0x11, 0x11,
	0x11, 0x23, 0x32, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x21, 0x00, 0x11, 0x01, 0x34, 0x32, 0x11,
	0x01, 0x33, 0x21, 0x01, 0x11, 0x11, 0x10, 0x00, 0x00, 0x01, 0x11, 0x11, 0x10, 0x13, 0x32, 0x10,
	0x12, 0x33, 0x10, 0x24, 0x55, 0x55, 0x54, 0x33, 0x33, 0x45, 0x55, 0x54, 0x31, 0x01, 0x33, 0x11,
	0x13, 0x32, 0x01, 0x45, 0x55, 0x68, 0x88, 0x86, 0x68, 0x88, 0x86, 0x55, 0x52, 0x00, 0x23, 0x21,
	0x12, 0x21, 0x02, 0x44, 0x22, 0x58, 0xBD, 0xD8, 0xBD, 0xD8, 0x64, 0x24, 0x44, 0x10, 0x23, 0x21,
	0x02, 0x30, 0x04, 0x52, 0x11, 0x24, 0x55, 0x66, 0x86, 0x54, 0x42, 0x11, 0x45, 0x20, 0x13, 0x21,
	0x12, 0x21, 0x04, 0x41, 0x20, 0x00, 0x01, 0x24, 0x42, 0x00, 0x00, 0x12, 0x25, 0x40, 0x12, 0x21,
	0x12, 0x11, 0x24, 0x44, 0x21, 0x11, 0x01, 0x45, 0x42, 0x10, 0x10, 0x24, 0x44, 0x42, 0x12, 0x10,
	0x11, 0x12, 0x45, 0x55, 0x42, 0x22, 0x44, 0x68, 0x85, 0x44, 0x22, 0x44, 0x55, 0x52, 0x11, 0x10,
	0x11, 0x12, 0x45, 0x88, 0x55, 0x55, 0x55, 0x8D, 0xB6, 0x55, 0x55, 0x56, 0x86, 0x54, 0x11, 0x11,
	0x11, 0x02, 0x45, 0x88, 0x88, 0x66, 0x56, 0xBE, 0xEB, 0x65, 0x68, 0x88, 0x86, 0x54, 0x10, 0x11,
	0x10, 0x02, 0x44, 0x58, 0x88, 0x85, 0x46, 0x8B, 0xD8, 0x54, 0x68, 0x88, 0x65, 0x42, 0x10, 0x00,
	0x10, 0x12, 0x24, 0x45, 0x86, 0x54, 0x24, 0x45, 0x54, 0x22, 0x45, 0x88, 0x55, 0x42, 0x21, 0x00,
	0x11, 0x12, 0x44, 0x45, 0x66, 0x54, 0x42, 0x22, 0x22, 0x34, 0x45, 0x66, 0x44, 0x42, 0x21, 0x11,
	0x13, 0x22, 0x44, 0x44, 0x55, 0x44, 0x54, 0x22, 0x23, 0x45, 0x44, 0x55, 0x44, 0x44, 0x12, 0x21,
	0x13, 0x33, 0x44, 0x44, 0x44, 0x44, 0x55, 0x44, 0x44, 0x54, 0x44, 0x44, 0x44, 0x54, 0x34, 0x31,
	0x13, 0x45, 0x55, 0x32, 0x32, 0x34, 0x45, 0x55, 0x55, 0x54, 0x32, 0x33, 0x24, 0x55, 0x54, 0x21,
	0x12, 0x46, 0x65, 0x22, 0x42, 0x13, 0x56, 0x88, 0x88, 0x64, 0x21, 0x34, 0x23, 0x66, 0x64, 0x20,
	0x01, 0x36, 0x8B, 0x64, 0x53, 0x00, 0x46, 0x8B, 0x88, 0x53, 0x00, 0x45, 0x46, 0xB6, 0x42, 0x00,
	0x00, 0x13, 0x6B, 0x65, 0x64, 0x12, 0x46, 0x66, 0x66, 0x53, 0x22, 0x56, 0x58, 0xB5, 0x21, 0x00,
	0x00, 0x11, 0x45, 0x55, 0x85, 0x45, 0x66, 0x88, 0x88, 0x66, 0x54, 0x56, 0x54, 0x65, 0x11, 0x00,
	0x02, 0x11, 0x44, 0x35, 0x55, 0x55, 0x66, 0x66, 0x66, 0x66, 0x55, 0x55, 0x43, 0x45, 0x11, 0x10,
	0x02, 0x24, 0x42, 0x23, 0x44, 0x56, 0x66, 0x65, 0x66, 0x66, 0x55, 0x43, 0x32, 0x34, 0x13, 0x10,
	0x01, 0x22, 0x31, 0x22, 0x22, 0x46, 0x66, 0x54, 0x45, 0x66, 0x53, 0x22, 0x21, 0x23, 0x22, 0x00,
	0x00, 0x00, 0x00, 0x22, 0x21, 0x24, 0x44, 0x43, 0x34, 0x44, 0x32, 0x12, 0x21, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x24, 0x20, 0x12, 0x23, 0x33, 0x33, 0x32, 0x20, 0x02, 0x42, 0x10, 0x00, 0x00,
	0x10, 0x00, 0x01, 0x11, 0x10, 0x00, 0x01, 0x11, 0x11, 0x10, 0x00, 0x01, 0x11, 0x10, 0x00, 0x00,
	0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,

	0x00, 0x12, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x00, 0x00,
	0x11, 0x11, 0x22, 0x12, 0x23, 0x33, 0x45, 0x65, 0x43, 0x34, 0x33, 0x22, 0x22, 0x21, 0x00, 0x01,
	0x11, 0x12, 0x33, 0x33, 0x35, 0x55, 0x68, 0x88, 0x65, 0x66, 0x55, 0x43, 0x33, 0x32, 0x11, 0x11,
	0x01, 0x23, 0x32, 0x22, 0x22, 0x33, 0x34, 0x55, 0x55, 0x54, 0x33, 0x22, 0x22, 0x23, 0x32, 0x11,
	0x01, 0x23, 0x21, 0x11, 0x12, 0x22, 0x23, 0x44, 0x44, 0x43, 0x21, 0x11, 0x11, 0x22, 0x32, 0x10,
	0x11, 0x22, 0x10, 0x12, 0x22, 0x24, 0x44, 0x22, 0x22, 0x44, 0x33, 0x22, 0x11, 0x11, 0x33, 0x10,
	0x12, 0x21, 0x01, 0x22, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x54, 0x43, 0x22, 0x01, 0x23, 0x21,
	0x02, 0x31, 0x01, 0x24, 0x33, 0x44, 0x55, 0x55, 0x55, 0x54, 0x44, 0x33, 0x32, 0x10, 0x13, 0x21,
	0x02, 0x20, 0x02, 0x22, 0x21, 0x34, 0x45, 0x54, 0x45, 0x54, 0x42, 0x22, 0x23, 0x10, 0x13, 0x21,
	0x12, 0x21, 0x12, 0x21, 0x44, 0x22, 0x23, 0x44, 0x44, 0x32, 0x22, 0x42, 0x24, 0x20, 0x01, 0x10,
	0x11, 0x11, 0x13, 0x44, 0x45, 0x42, 0x22, 0x24, 0x42, 0x22, 0x24, 0x54, 0x44, 0x21, 0x01, 0x10,
	0x11, 0x00, 0x24, 0x55, 0x77, 0x54, 0x44, 0x44, 0x32, 0x24, 0x57, 0x75, 0x44, 0x41, 0x01, 0x10,
	0x00, 0x01, 0x45, 0x55, 0x77, 0x75, 0x24, 0x45, 0x54, 0x44, 0x57, 0x75, 0x55, 0x42, 0x00, 0x11,
	0x10, 0x01, 0x47, 0x77, 0x88, 0x85, 0x55, 0x7B, 0xB7, 0x55, 0x88, 0x88, 0x87, 0x54, 0x10, 0x01,
	0x10, 0x02, 0x45, 0x88, 0x88, 0x85, 0x57, 0xBD, 0xB8, 0x55, 0x88, 0x88, 0x87, 0x52, 0x10, 0x00,
	0x10, 0x01, 0x24, 0x78, 0x88, 0x75, 0x57, 0x8B, 0x88, 0x55, 0x78, 0x88, 0x85, 0x41, 0x10, 0x00,
	0x11, 0x11, 0x14, 0x57, 0x87, 0x55, 0x55, 0x88, 0x87, 0x55, 0x55, 0x88, 0x55, 0x31, 0x11, 0x11,
	0x12, 0x11, 0x24, 0x44, 0x55, 0x44, 0x45, 0x55, 0x55, 0x54, 0x45, 0x55, 0x44, 0x42, 0x12, 0x21,
	0x13, 0x22, 0x44, 0x21, 0x34, 0x23, 0x34, 0x44, 0x44, 0x43, 0x24, 0x33, 0x24, 0x42, 0x23, 0x21,
	0x12, 0x43, 0x34, 0x21, 0x22, 0x13, 0x54, 0x23, 0x32, 0x44, 0x22, 0x22, 0x22, 0x43, 0x34, 0x21,
	0x13, 0x44, 0x44, 0x32, 0x22, 0x13, 0x44, 0x43, 0x34, 0x44, 0x21, 0x22, 0x13, 0x44, 0x44, 0x20,
	0x02, 0x45, 0x55, 0x42, 0x42, 0x11, 0x44, 0x54, 0x45, 0x42, 0x11, 0x34, 0x25, 0x55, 0x54, 0x10,
	0x00, 0x45, 0x55, 0x44, 0x53, 0x11, 0x45, 0x77, 0x76, 0x52, 0x11, 0x45, 0x45, 0x55, 0x52, 0x00,
	0x00, 0x24, 0x55, 0x44, 0x54, 0x24, 0x57, 0x88, 0x87, 0x54, 0x32, 0x55, 0x33, 0x55, 0x41, 0x00,
	0x01, 0x11, 0x66, 0x44, 0x55, 0x45, 0x55, 0x55, 0x55, 0x55, 0x44, 0x55, 0x35, 0x65, 0x11, 0x10,
	0x01, 0x14, 0x45, 0x44, 0x45, 0x55, 0x55, 0x57, 0x75, 0x55, 0x55, 0x54, 0x44, 0x54, 0x11, 0x00,
	0x00, 0x23, 0x22, 0x34, 0x23, 0x55, 0x55, 0x57, 0x55, 0x55, 0x55, 0x32, 0x42, 0x22, 0x31, 0x00,
	0x01, 0x22, 0x21, 0x12, 0x22, 0x55, 0x55, 0x55, 0x55, 0x55, 0x54, 0x22, 0x21, 0x12, 0x21, 0x10,
	0x00, 0x12, 0x11, 0x11, 0x11, 0x24, 0x54, 0x44, 0x44, 0x55, 0x42, 0x21, 0x11, 0x11, 0x11, 0x00,
	0x10, 0x01, 0x00, 0x00, 0x00, 0x12, 0x33, 0x33, 0x33, 0x34, 0x21, 0x11, 0x00, 0x00, 0x10, 0x00,
	0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,

	0x00, 0x12, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x00, 0x00,
	0x10, 0x12, 0x22, 0x12, 0x22, 0x12, 0x34, 0x43, 0x32, 0x33, 0x22, 0x21, 0x12, 0x22, 0x00, 0x01,
	0x11, 0x12, 0x33, 0x33, 0x44, 0x44, 0x66, 0x86, 0x54, 0x66, 0x54, 0x43, 0x23, 0x32, 0x10, 0x11,
	0x01, 0x23, 0x33, 0x33, 0x33, 0x44, 0x45, 0x66, 0x55, 0x66, 0x54, 0x33, 0x33, 0x33, 0x32, 0x11,
	0x01, 0x23, 0x21, 0x12, 0x22, 0x34, 0x44, 0x45, 0x54, 0x44, 0x43, 0x22, 0x22, 0x22, 0x32, 0x10,
	0x11, 0x22, 0x10, 0x01, 0x11, 0x11, 0x22, 0x22, 0x22, 0x22, 0x11, 0x11, 0x10, 0x12, 0x22, 0x11,
	0x12, 0x21, 0x00, 0x12, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x22, 0x21, 0x00, 0x22, 0x21,
	0x02, 0x21, 0x01, 0x22, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x22, 0x22, 0x00, 0x13, 0x21,
	0x02, 0x20, 0x02, 0x22, 0x22, 0x22, 0x22, 0x21, 0x12, 0x22, 0x22, 0x22, 0x22, 0x10, 0x02, 0x21,
	0x11, 0x10, 0x02, 0x21, 0x11, 0x24, 0x44, 0x42, 0x44, 0x44, 0x42, 0x11, 0x12, 0x10, 0x01, 0x11,
	0x10, 0x00, 0x01, 0x22, 0x22, 0x23, 0x45, 0x43, 0x44, 0x54, 0x22, 0x22, 0x12, 0x10, 0x01, 0x10,
	0x11, 0x01, 0x22, 0x45, 0x54, 0x21, 0x22, 0x22, 0x22, 0x21, 0x12, 0x55, 0x43, 0x21, 0x01, 0x10,
	0x00, 0x01, 0x34, 0x57, 0x9A, 0xA5, 0x21, 0x13, 0x31, 0x14, 0x7A, 0xA7, 0x75, 0x42, 0x00, 0x11,
	0x10, 0x02, 0x45, 0x79, 0x9C, 0x97, 0x44, 0x56, 0x55, 0x45, 0x9C, 0xC9, 0x77, 0x53, 0x00, 0x01,
	0x10, 0x02, 0x45, 0x79, 0x77, 0x77, 0x56, 0x8D, 0xB8, 0x65, 0x77, 0x77, 0x77, 0x52, 0x00, 0x00,
	0x10, 0x01, 0x24, 0x88, 0x88, 0x85, 0x66, 0xBE, 0xB8, 0x66, 0x88, 0x88, 0x86, 0x41, 0x00, 0x00,
	0x10, 0x01, 0x14, 0x58, 0x88, 0x65, 0x55, 0xBE, 0xD8, 0x55, 0x56, 0x88, 0x85, 0x30, 0x00, 0x01,
	0x11, 0x00, 0x13, 0x44, 0x55, 0x42, 0x44, 0x68, 0x85, 0x43, 0x24, 0x55, 0x54, 0x20, 0x00, 0x11,
	0x12, 0x10, 0x22, 0x22, 0x44, 0x21, 0x32, 0x44, 0x43, 0x22, 0x22, 0x44, 0x22, 0x21, 0x02, 0x21,
	0x13, 0x21, 0x22, 0x22, 0x42, 0x23, 0x33, 0x22, 0x22, 0x33, 0x22, 0x34, 0x22, 0x22, 0x12, 0x21,
	0x13, 0x21, 0x23, 0x21, 0x21, 0x13, 0x44, 0x22, 0x23, 0x44, 0x21, 0x22, 0x13, 0x31, 0x13, 0x20,
	0x12, 0x32, 0x13, 0x32, 0x21, 0x01, 0x34, 0x43, 0x34, 0x42, 0x11, 0x12, 0x23, 0x21, 0x33, 0x20,
	0x01, 0x44, 0x21, 0x23, 0x32, 0x00, 0x24, 0x44, 0x44, 0x41, 0x00, 0x23, 0x32, 0x13, 0x43, 0x10,
	0x01, 0x45, 0x32, 0x24, 0x32, 0x11, 0x24, 0x55, 0x55, 0x42, 0x11, 0x34, 0x32, 0x24, 0x41, 0x00,
	0x01, 0x24, 0x44, 0x34, 0x44, 0x42, 0x34, 0x55, 0x55, 0x42, 0x34, 0x44, 0x33, 0x44, 0x41, 0x00,
	0x01, 0x24, 0x56, 0x53, 0x45, 0x54, 0x45, 0x56, 0x55, 0x54, 0x45, 0x54, 0x45, 0x64, 0x41, 0x10,
	0x01, 0x24, 0x44, 0x43, 0x34, 0x55, 0x56, 0x65, 0x56, 0x65, 0x55, 0x43, 0x34, 0x44, 0x42, 0x10,
	0x01, 0x22, 0x21, 0x12, 0x23, 0x58, 0x65, 0x55, 0x55, 0x56, 0x65, 0x32, 0x20, 0x12, 0x22, 0x10,
	0x00, 0x12, 0x10, 0x01, 0x11, 0x35, 0x65, 0x44, 0x44, 0x66, 0x54, 0x21, 0x00, 0x01, 0x21, 0x00,
	0x10, 0x01, 0x00, 0x00, 0x00, 0x13, 0x33, 0x33, 0x33, 0x44, 0x32, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01
};


/*
===============
Host_WriteConfiguration

Writes key bindings and archived cvars to config.cfg
===============
*/
void Host_WriteConfiguration (void)
{
	uint8	buffer[8];
	uint16	crc;
	int	filesize, total, head_len=1664;
	char	vmu_path[21], *file_buf, *ptr, playername[33];
	FILE	*f1;
	file_t	f2;

// dedicated servers initialize the host but don't parse and set the
// config.cfg cvars

	if (host_initialized && !isDedicated)
	{
// Saving options to RAM
		f1 = fopen ("/ram/save.cfg", "w");
		if (!f1)
		{
			Con_Printf ("Couldn't write config file.\n");
			return;
		}

		Key_WriteBindings (f1);
		Cvar_WriteVariables (f1);

		fclose (f1);


// Reading options
		f2 = fs_open("/ram/save.cfg", O_RDONLY);
		filesize= fs_total(f2);

		total = filesize + head_len;
		while ((total % 512) != 0)
			total ++;

		file_buf = (char *)malloc(total+1);
		if (file_buf == NULL) {
			Con_Printf ("Not enough memory.\n");
			fs_unlink("/ram/save.cfg");
			fs_close(f2);
			return;
		}

		memset(file_buf, 0, total);

		fs_read(f2, file_buf+head_len, filesize);
		fs_close(f2);


// Filling VMS header
		ptr = file_buf;

		sprintf(playername, "%-32s", Cvar_VariableString("_cl_name"));

		memcpy(ptr, "\x12RADQUAKE CONFIG",16);	ptr += 16;	// VM desc
		memcpy(ptr, playername,		32);	ptr += 32;	// DC desc: playername
		memcpy(ptr, "RADQuake        ",	16);	ptr += 16;	// Application
		memcpy(ptr, "\x03\0",		2);	ptr += 2;	// Icons number
		memcpy(ptr, "\x0a\0",		2);	ptr += 2;	// Anim speed
		memset(ptr, 0,			2);	ptr += 2;	// Eyecatch type
		memset(ptr, 0,			2);	ptr += 2;	// CRC checksum

		sprintf(buffer, "%c%c%c%c",
			(filesize & 0xff)	>> 0,
			(filesize & 0xff00)	>> 8,
			(filesize & 0xff0000)	>> 16,
			(filesize & 0xff000000)	>> 24);

		memcpy(ptr, buffer,		4);	ptr += 4;	// Filesize
		memset(ptr, 0,			20);	ptr += 20;	// Reserved
		memcpy(ptr, anim_palette, 	32);	ptr += 32;	// Icons palette
		memcpy(ptr, anim_bitmap, 	3*512);	ptr += 3*512;	// Icons bitmap


// Calculating CRC checksum
		crc = VMU_calcCRC(file_buf, filesize+head_len);

		file_buf[0x46] = (crc & 0xff)	>> 0;
		file_buf[0x47] = (crc & 0xff00)	>> 8;


// Saving config to VM
		vm_dev = maple_enum_dev((int)vmu_port.value, (int)vmu_unit.value);
		if (vm_dev == NULL) {
			Con_Printf ("ERROR: no VM in %c-%d.\n", (int)vmu_port.value+'A', (int)vmu_unit.value);
			fs_unlink("/ram/save.cfg");
			free(file_buf);
			return;
		}

		freeblocks = VMU_GetFreeblocks();

		if (freeblocks == -1) {
			Con_Printf ("ERROR: couldn't read root block.\n");
			fs_unlink("/ram/save.cfg");
			free(file_buf);
			return;
		} else if (freeblocks == -2) {
			Con_Printf ("ERROR: couldn't read FAT.\n");
			fs_unlink("/ram/save.cfg");
			free(file_buf);
			return;
		}

		sprintf(vmu_path, "/vmu/%c%d/RADQUAKE_CFG", (int)vmu_port.value+'a', (int)vmu_unit.value);
		f2 = fs_open(vmu_path, O_RDONLY);
		if (f2) {
			freeblocks += fs_total(f2) / 512;
			fs_close(f2);
		}

		if ((freeblocks*512) < total) {
			Con_Printf ("Not enough free blocks. Free:%d Needed:%d.\n", freeblocks, total/512);
			fs_unlink("/ram/save.cfg");
			free(file_buf);
			return;
		}

		Con_Printf("Saving options to %s...\n", vmu_path);

		fs_unlink(vmu_path);

		f2 = fs_open (vmu_path, O_WRONLY);
		if (!f2)
		{
			Con_Printf ("ERROR: couldn't open.\n");
			fs_unlink("/ram/save.cfg");
			free(file_buf);
			return;
		}

		fs_write(f2, file_buf, total);
		fs_close(f2);


		fs_unlink("/ram/save.cfg");
		free(file_buf);

		Con_Printf("done.\n");
	}
}



/*
===============
Host_ReadConfiguration

Added by speud
===============
*/
void Host_ReadConfiguration (void) {
	FILE	*f;
	char	path[32], *file_buf, buffer[32];
	int	head_len;
	uint16	icons_n, crc, eyec_t;
	uint32	data_len;


	sprintf(path, "/vmu/%c%d/RADQUAKE_CFG", (int)vmu_port.value+'a', (int)vmu_unit.value);
	path[20] = 0;

	Con_Printf ("Reading settings from %s...\n", path);

	f = fopen(path, "r");

	if (!f) {
		Con_Printf ("No config file found in %c-%d.\n", (int)vmu_port.value+'A', (int)vmu_unit.value);
		return;
	}


// Skipping DC/VM desc
	fseek(f, 48, SEEK_SET);


// Checking application name
	fread(buffer, 16, 1, f);

	if (!!memcmp(buffer, "RADQuake        ", 16))
	{
		Con_Printf ("ERROR: not a valid RADQuake game save. (%s)\n", buffer);
		fclose(f);
		return;
	}

		
// Checking icons number
	fread(&icons_n, 2, 1, f);

	if (icons_n<1 || icons_n>3)
	{
		Con_Printf ("ERROR: not a valid VMS icon. (%d)\n", icons_n);
		fclose(f);
		return;
	}


// Skipping icons anim speed
	fseek(f, 2, SEEK_CUR);


// Checking eyecatch type
	fread(&eyec_t, 2, 1, f);

	if (eyec_t > 3)
	{
		Con_Printf ("ERROR: not a valid VMS eyecatch. (%d)\n", eyec_t);
		fclose(f);
		return;
	}


// Getting data size
	fread(&crc, 2, 1, f);
	fread(&data_len, 4, 1, f);
//	Con_Printf ("Data's length: %d;\n", data_len);
	head_len = 128 + icons_n*512;

	if (eyec_t > 0) {
		switch (eyec_t) {
			case 1: head_len += 8064; break;
			case 2: head_len += 4544; break;
			case 3: head_len += 2048; break;
		}
	}

//	Con_Printf ("VMS header's length: %d.\n", head_len);


// Reading options
	file_buf = (char *)malloc(data_len+1);
	if (file_buf == NULL) {
		Con_Printf ("ERROR: not enough memory.\n");
		fclose(f);
		return;
	}

	fseek(f, head_len, SEEK_SET);
	fread(file_buf, data_len, 1, f);
	fclose(f);

	Cbuf_AddText ("echo \"Loading user's settings...\"\n");
	Cbuf_AddText (file_buf);
	Cbuf_AddText ("echo \"done.\"\n");

	free(file_buf);
}
